<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="TWReader.UIBroker">
<Super>Util.UIBroker</Super>
<TimeCreated>63623,17389.188202</TimeCreated>

<Parameter name="ContextType">
<Type>%String</Type>
<Default>TW</Default>
</Parameter>

<Method name="DrawTrends">
<ClassMethod>1</ClassMethod>
<FormalSpec>fields:%String="",tableName:%String="#trends-table",lat:%String,long:%String</FormalSpec>
<Implementation><![CDATA[
	s response=""
	do ##class(TWReader.Requests.APIMethodsCaller).GetPlaceByCoords(.place,lat,long)
	set woeid = place.GetAt(1)."woeid"
	do ##class(TWReader.Requests.APIMethodsCaller).GetTrendsByPlaceJSON(.response,woeid)
	
	set response = $replace(response,"[{","{",1,1)
	set response = $replace(response,"}]}]","}]}")
	set response = $replace(response,"name","sourceId")
	
	&js<
		trends = (#(response)#).trends;
		drawTable('#(tableName)#', trends, #(fields)#,'#');
	>
]]></Implementation>
</Method>

<Method name="AddMorePostsByCoords">
<ClassMethod>1</ClassMethod>
<FormalSpec>shouldClearDomain:%String,numberOfSources:%String,lat:%Float,long:%Float</FormalSpec>
<Implementation><![CDATA[
	if (##class(Util.Misc).IsInteger(numberOfSources)) {
		if (numberOfSources > ##class(TWReader.Requests.APIMethodsCaller).%GetParameter("MaxEntityQueryCount")) {
			set numberOfSources = ##class(TWReader.Requests.APIMethodsCaller).%GetParameter("MaxEntityQueryCount")
		}
		set context = ##class(TWReader.Data.Context).%New(shouldClearDomain)
		///Get Place object by coordinates
		do ##class(TWReader.Requests.APIMethodsCaller).GetPlaceByCoords(.place,lat,long)
		///A WOEID is a Yahoo! Where On Earth ID.
		set woeid = place.GetAt(1)."woeid"
		///Get trends by woeid (set 3 param equal to hashtags will remove all hashtags from the trends list.)
		do ##class(TWReader.Requests.APIMethodsCaller).GetTrendsByPlace(.response,woeid,"")
		set trends = ##class(%ArrayOfObjects).%New()
		set trends = response.GetAt(1)."trends"
		for i = 1:1:trends.Count() {
			set name = trends.GetAt(i)."name"
			do context.AddMorePosts(name, numberOfSources)
		}
} else {
		&js<console.log("Incorrect value for number of posts.")>
	}
	do ..DrawTable()
	&js<
		$("#add-tweets-by-trends-modal").modal('hide');
	   	$("#add-tweets-by-trends-modal .progress").css("display", "none");
	    $("#add-tweets-button").prop('disabled', false);
	>
]]></Implementation>
</Method>
</Class>
</Export>
