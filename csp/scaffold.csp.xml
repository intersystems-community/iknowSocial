<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<CSP name="scaffold.CSP" application="/csp/iknowsocial/" default="1"><![CDATA[
<!DOCTYPE html>
<html>
<head>
<title>Closure Builder</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<script src="//code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<style>
body {
  	padding-top: 70px;
}
.highlighted-row {
	background-color: #87B5DC;
}
</style>
<script language="Javascript">
$(document).ready(function() {
	
	var getDomainId = function() {
		var res = ($("#domain-chooser button").text()).split(" ");
		console.log(res)
		return res[0]
	}
	
	var toggleTableRow = function(tableId, row) {
		var tableRows = $(tableId + " tr");
		row.toggleClass("highlighted-row");
		$(tableId + "-main-button").prop("disabled", tableRows.filter(".highlighted-row").length < 1);
	};
	
	var unhighlightTableRow = function(tableId, row) {
		var tableRows = $(tableId + " tr");
		row.removeClass("highlighted-row");
		$(tableId + "-main-button").prop("disabled", tableRows.filter(".highlighted-row").length < 1);	
	}
	
	var toggleWholeTable = function(tableId) {
		var tableRows = $(tableId + " tr");
		tableRows.each(function() {
			toggleTableRow(tableId, $(this));
		});
	};
	
	var unhighlightWholeTable = function(tableId) {
		var tableRows = $(tableId + " tr");
		tableRows.each(function() {
			unhighlightTableRow(tableId, $(this));
		});
	}
	
	var setTableToggling = function(tableId) {
		console.log(tableId);
		var tableRows = $(tableId + " tr");
		tableRows.off("click");
		tableRows.click(function() {
			toggleTableRow(tableId, $(this));
		});
	};
	
	var setSearch = function(tableId) {
		$(tableId + '-search-pane').keyup(function() {
			var text = $(this).val();
			$(tableId + ' tr td:nth-child(2)').each(function() {
				var elem = $(this);
				if (elem.text().indexOf(text) > -1) {
					elem.parent().css({
						"display":"table-row"
					});
				} else {
					elem.parent().css({
						"display":"none"
					});
				}
			});
		});
	}
	
	setTableToggling("#left-table");
	
	$("#select-all-to-propose").click(function() {
		toggleWholeTable("#left-table")
	});
	
	$("#select-all-to-approve").click(function() {
		toggleWholeTable("#right-table")
	});
	
	$("#domain-chooser li").click(function() {
		$("#domain-chooser button").text($(this).text() + " ")
		$("#domain-chooser button").append("<span class=\"caret\"></span>")
	});
	
	setSearch("#left-table");
	setSearch("#right-table")
	
	$("#left-table-main-button").click(function() {
		var list = []
		$("#left-table .highlighted-row").each(function() {
			list.push($("th:nth-child(1)", this).text());
		});
		var domainId = getDomainId();
		var stringifiedList = list.join(",");
		var stringifiedResponse = #server(Misc.EmotionalMarker.ProposeStringifiedJSONClosureForCSVOfMarkerIds(stringifiedList, domainId))#;
		var response = JSON.parse(stringifiedResponse);
		for (var key in response) {
			$("#right-table tbody").append("<tr><th scope=\"row\">-</th><td>" + key + "</td><td>" + response[key] + "</td></tr>")
		}
		unhighlightWholeTable("#left-table");
		setTableToggling("#right-table");
	});
	
	$("#right-table-main-button").click(function() {
		var dict = {}
		$("#right-table .highlighted-row").each(function() {
			dict[$("td:nth-child(2)", this).text()] = $("td:nth-child(3)", this).text();
		});
		var stringifiedDict = JSON.stringify(dict);
		var stringifiedJSON = #server(Misc.EmotionalMarker.ApproveMarkersFromJSONAndReturnJSONWithIds(stringifiedDict))#
		dict = JSON.parse(stringifiedJSON)
		$("#right-table .highlighted-row").prependTo("#left-table")
		$("#left-table .highlighted-row").each(function() {
			console.log(dict[$("td:nth-child(2)", this).text()]);
			console.log($("th:nth-child(1)", this).text());
			$("th:nth-child(1)", this).text(dict[$("td:nth-child(2)", this).text()]);
		});
		unhighlightWholeTable("#left-table")
		$("#right-table-main-button").prop("disabled", true)
		setTableToggling("#left-table")
	});
});
</script>
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Emotional markers closure builder</a>
    </div>
    <div class="btn-group pull-right" id="domain-chooser">
      <script language="cache" runat="server">
       	set query = "select distinct * from %iKnow.""Domain"""
		set statement = ##class(%SQL.Statement).%New()
		set status = statement.%Prepare(query)
		set result = statement.%Execute()
		w "<button type=""button"" class=""btn btn-default navbar-btn dropdown-toggle"" data-toggle=""dropdown"" aria-expanded=""false"">"
		do result.%Next()  
		w result.Id _ " " _ result.Name _ " "
		w "<span class=""caret""></span>"
		w "</button>", !
		w "<ul class=""dropdown-menu"" role=""menu"">", !
		w "<li><a href=""#"">" _ result.Id _ " " _ result.Name _ "</a></li>", !
		while result.%Next() {
			w "<li><a href=""#"">" _ result.Id _ " " _ result.Name _ "</a></li>", !
		} 
		w "</ul>"
     </script>
    </div>
  </div>
</nav>
<div class="container">
  <div class="row">
    <div class="col-md-4 col-md-offset-1">
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Search for..." id="left-table-search-pane">
        <span class="input-group-btn">
          <button class="btn btn-default" type="button">Go!</button>
        </span>
      </div>
    </div>
    <div class="col-md-4 col-md-offset-2">
      <div class="input-group">
        <input type="text" class="form-control" placeholder="Search for..." id="right-table-search-pane">
        <span class="input-group-btn">
          <button class="btn btn-default" type="button">Go!</button>
        </span>
      </div>
    </div>
  </div>
  <div class="row" style="margin-top:10px">
    <div class="col-md-4 col-md-offset-1">
      <div class="panel panel-default">
        <table class="table">
            <caption>Approved emotional markers.</caption>
            <thead>
              <tr>
                <th>Id</th>
                <th>Entity</th>
                <th>Weight</th>
              </tr>
            </thead>
        </table>
        <div  style="height:60vh;overflow-y:auto">
          <table class="table" id="left-table">
            <tbody>
              <script language="cache" runat="server">
               	set query = "select distinct * from Misc.EmotionalMarker"
				set statement = ##class(%SQL.Statement).%New()
				set status = statement.%Prepare(query)
				set result = statement.%Execute()
				while result.%Next() {
					w "<tr>", !
					w "<th scope=""row"">" _ result.Id _ "</th>", !
					w "<td>"_ result.Entity _"</td>", !
					w "<td>"_ result.Weight _"</td>", !
					w "</tr>", !
				} 
             </script>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="col-md-4 col-md-offset-2">
      <div class="panel panel-default">
        <table class="table">
            <caption>Proposed emotional markers.</caption>
            <thead>
              <tr>
                <th>#</th>
                <th>Entity</th>
                <th>Weight</th>
              </tr>
            </thead>
        </table>
        <div  style="height:60vh;overflow-y:auto">
          <table class="table" id="right-table">
            <tbody>
              
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-4 col-md-offset-1">
      <div class="pull-right">
        <button type="button" class="btn btn-default" id="select-all-to-propose">Select All</button>
        <button type="button" class="btn btn-primary" id="left-table-main-button" disabled>Propose Closure</button>
      </div>
    </div>
    <div class="col-md-4 col-md-offset-2">
      <div class="pull-right">
        <button type="button" class="btn btn-default" id="select-all-to-approve">Select All</button>
        <button type="button" class="btn btn-primary" id="right-table-main-button"disabled>Approve</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
]]></CSP>
</Export>
