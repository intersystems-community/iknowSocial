<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Routine name="Twitter" type="MAC" languagemode="0"><![CDATA[
Twitter(term)

	// Create a new domain if it not exists or open an existing one
	if (##class(%iKnow.Domain).Exists("Twitter")) {
		set dom=##class(%iKnow.Domain).Open("Twitter")
		Do dom.DropData(1,1,1)
	} else {
		set dom=##class(%iKnow.Domain).Create("Twitter",0)
	} 
	
	// Set the metadata you wan to use
	// The Datasource we are going to use will report the following metadata fields
	do ##class(%iKnow.Queries.MetadataAPI).AddField(dom.Id, "Title", $lb("="))
	do ##class(%iKnow.Queries.MetadataAPI).AddField(dom.Id, "Author",  $lb("="))
	do ##class(%iKnow.Queries.MetadataAPI).AddField(dom.Id, "Date",  $lb("="))
	do ##class(%iKnow.Queries.MetadataAPI).AddField(dom.Id, "Time",  $lb("="))
	
	// Create or open a configuration for indexing
	// The configuration created below uses Automatic language detection
	if (##class(%iKnow.Configuration).Exists("TwitterCfg")) {
		set config=##class(%iKnow.Configuration).Open("TwitterCfg")
	} else {
		set config=##class(%iKnow.Configuration).Create("TwitterCfg",1,$LB("nl","en","fr","de","ru","uk"))
	}
	set loader = ##class(%iKnow.Source.Loader).%New(dom.Id)
	do loader.Reset()

	#dim requester as Requester = ##class(TwitterReader.Requester).%New()
	#dim queryText as %String = term
	#dim resultType = "recent"
	#dim maxId as %Integer = ""
	#dim sinceId as %Integer = ""
	#dim until as %Date = ""
	#dim count as %Integer = 500
	#dim tweets as %ListOfObjects = requester.Search(queryText, resultType, sinceId, until, count, maxId)
	#dim tweetCount as %Integer = tweets.Count()
	;write count, " tweets", !
	Kill ^TwitterD
	for i=1:1:tweetCount
	{
		#dim tweet as Tweet = tweets.GetAt(i)
		;tweet.Text
	
		set ^TwitterD(i,"D")=tweet.Text
		set ^TwitterD(i,"MD")=$lb("",tweet.UserId,$Piece(tweet.CreatedAtDateTime,",",1),$Piece(tweet.CreatedAtDateTime,",",2))
	}
	
	set lister = ##class(Twitter.GlobalLister).%New(dom.Id)
	do lister.SetConfig("TwitterCfg")
	do lister.AddListToBatch("")
	set ok = loader.ProcessBatch()
	
	set ds=""
	set config=""
	set dom=""

	quit

	
Clean()
	if (##class(%iKnow.Domain).Exists("Twitter")) {
		w !,"OPEN"
		set dom=##class(%iKnow.Domain).Open("Twitter")
		Do dom.DropData(1,1,1)
	}
	quit
]]></Routine>
</Export>
